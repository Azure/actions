name: health-dashboard
'on':
  - workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Generate Dashboard
        id: dashboard
        uses: ethomson/issue-dashboard@v1
        with:
          config: |
            title: 'Health Dashboard'
            output:
              format: html
              filename: 'health-dashboard.html'
            setup: | 
                  const repos = 'repo:Azure/login repo:Azure/webapps-deploy repo:Azure/aci-deploy repo:build-vm-image repo:Azure/deploy-to-azure-cli-extension repo:Azure/functions-action repo:Azure/functions-container-action repo:Azure/mysql repo:Azure/postgresql repo:Azure/powershell repo:Azure/sql-action'
                  userdata.count = async function(itemType,label) {
                    const state = (label==="closed")? "closed" : "open"
                    var results
                    if(label === "" || label === "closed") {
                        results = await github.search.issuesAndPullRequests(
                        { q: `${repos} is:${itemType} is:${state}`}
                        )
                    }
                    else if(label === "stale") {
                      results = await github.search.issuesAndPullRequests(
                      { q: `${repos} is:${itemType} is:${state} created:<${date("-90 days")}`}
                      )
                    } 
                    else{
                      results = await github.search.issuesAndPullRequests(
                      { q: `${repos} is:${itemType} is:${state} label:${label}`}
                      )
                    }
                    if(results.data.items.length === 0){
                      return '0'
                    }
                    else{
                      return results.data.total_count 
                    }
                  }
                  
                  userdata.url = async function(itemType,label) {
                    const state = (label==="closed")? "closed" : "open"
                    var url;
                    if(label === "" || label === "closed") {
                      url = 'https://github.com/search?q='+ repos + '+is%3A'+ itemType + '+is%3A' + state 
                    }
                    else if(label === "stale") {
                      var today = new Date();
                      var pastDate = new Date(today);
                      pastDate.setDate(pastDate.getDate() - 90);
                      var staledate = pastDate.toISOString().split("T")[0];
                      url = 'https://github.com/search?q=' + repos + '+is%3A' + itemType + '+is%3A' + state + '+created%3A<'+ staledate
                    }
                    else{
                      url = 'https://github.com/search?q='+ repos + '+is%3A'+ itemType + '+is%3A' + state + '+label%3A' + label
                    }
                    return url
                  } 

            sections:
            - title: 'Issues'
              widgets:
              - type: 'number'
                title: 'Idle (inactive >14days)'
                value: '{{ userdata.count("issue","idle") }}'
                url: '{{ userdata.url("issue","idle") }}'
              - type: 'number'
                title: 'P0 bugs'
                value: '{{ userdata.count("issue","P0") }}'
                url: '{{ userdata.url("issue","P0") }}'
              - type: 'number'
                title: 'P1 bugs'
                value: '{{ userdata.count("issue","P1") }}'
                url: '{{ userdata.url("issue","P1") }}'
              - type: 'number'
                title: 'Enhancements'
                value: '{{ userdata.count("issue","enhancement") }}'
                url: '{{ userdata.url("issue","enhancement") }}'
              - type: 'number'
                title: 'Total issues'
                value: '{{ userdata.count("issue","") }}'
                url: '{{ userdata.url("issue","") }}'
                
            - title: 'Pull Requests'
              widgets:
              - type: 'number'
                title: 'Open'
                value: '{{ userdata.count("pr","") }}'
                url: '{{ userdata.url("pr","") }}'
              - type: 'number'
                title: 'Idle (inactive >14days)'
                value: '{{ userdata.count("pr","idle") }}'
                url: '{{ userdata.url("pr","idle") }}'
              - type: 'number'
                title: 'Stale (90 days old)'
                value: '{{ userdata.count("pr","stale") }}'
                url: '{{ userdata.url("pr","stale") }}' 
              - type: 'number'
                title: 'Closed'
                value: '{{ userdata.count("pr","closed") }}'
                url: '{{ userdata.url("pr","closed") }}'
                
            - title: 'Details'
              widgets:
              - type: 'string'
                value: 'Issues detailed information'
                url: 'issue.html'
              - type: 'string'
                value: 'PR detailed information'
                url: 'pr.html'
          token: "${{ github.token }}"
      - name: Commit files
        id: commit
        continue-on-error: true
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull
          git add --all
          if [-z "$(git status --porcelain)"]; then
             echo "::set-output name=push::false"
          else
             git commit -m "Add changes" -a
             echo "::set-output name=push::true"
          fi
        shell: bash
      - name: Push changes
        if: steps.commit.outputs.push == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: "${{ secrets.GITHUB_TOKEN }}"
